---
layout: default
---

<div class="home">
  <fieldset id="balance" class="pure-u-1-5">
    <legend>Solde du compte</legend>
    <span id="totalSpan"></span>
  </fieldset>
  <div class="pure-u-1-2" style="float:right">
    <fieldset>
      <legend>Solde membre</legend>
      <div class="pure-u-1">
        <input type="text" id="memberNameInput" placeholder="Member name">
        <div style="float:right"><span id="memberTotalSpan" style="line-height:28px; text-align:right"></span></div>
      </div>
    </fieldset>
  </div>
  <table class="pure-table pure-table-horizontal" style="width:100%; margin-bottom:2em">
    <thead>
      <tr>
        <th>Correspondant</th>
        <th>Date</th>
        <th class="amount">Montant</th>
      </tr>
    </thead>
    <tbody id="bankTbody"></tbody>
  </table>
</div>
<script>
  window.onload = () => {
    let memberTimer = null;
    const memberNameInput = document.getElementById('memberNameInput');
    memberNameInput.addEventListener('keydown', () => {
      const memberTotalSpan = document.getElementById('memberTotalSpan');
      clearTimeout(memberTimer);
      memberTimer = setTimeout(() => {
        fetch(`${mainUrl}/bank/${memberNameInput.value}`, {
          method: 'GET',
          mode: 'cors'
        })
        .then(res => res.json())
        .then(res => {
          const memberTotal = res.total/100;
          memberTotalSpan.textContent = memberTotal.toLocaleString('fr', currency);
        })
      }, 1000)
    })

    fetch(`${mainUrl}/bank`, {
      method: 'GET',
      mode: 'cors'
    })
    .then(res => res.json())
    .then(res => {
      const totalSpan = document.getElementById('totalSpan');
      const total = res.balance/100;
      totalSpan.textContent = total.toLocaleString('fr', currency)

      const bankTbody = document.getElementById('bankTbody');
      res.transactions.forEach(transaction => {
        const dateTd = document.createElement('td');
        const correspondantTd = document.createElement('td');
        const amountTd = document.createElement('td');

        const date = new Date(transaction.date);
        dateTd.textContent = date.toLocaleDateString('fr');

        let type;
        if(transaction.type === 'debit') {
          correspondantTd.textContent = transaction.label;
          type = '-';
          amountTd.className = 'amount';
        } else {
          correspondantTd.textContent = transaction.label.substr(0, 20);
          type = '+';
          amountTd.className = 'amount positif';
        }

        const amount = transaction.amount/100;
        amountTd.textContent = `${type} ${amount.toLocaleString('fr', currency)} `

        const bankTr = document.createElement('tr');
        bankTr.appendChild(correspondantTd)
        bankTr.appendChild(dateTd)
        bankTr.appendChild(amountTd);

        bankTbody.appendChild(bankTr);
      })
    })
  };
</script>
