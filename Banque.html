---
layout: default
---

<div class="home">
  <fieldset id="balance" class="pure-u-1-5">
    <legend>Solde du compte</legend>
    <span id="totalSpan"></span>
  </fieldset>
  <table class="pure-table pure-table-horizontal" style="width:100%; margin-bottom:2em">
    <thead>
      <tr>
        <th>Correspondant</th>
        <th>Date</th>
        <th class="amount">Montant</th>
      </tr>
    </thead>
    <tbody id="bankTbody"></tbody>
  </table>
</div>
<script>
  window.onload = async () => {
    window.onhashchange = loadBank;
    loadBank();
  };

  async function loadBank() {
    const member = location.hash.substr(1);
    fetch(`${mainUrl}/bank/${member}`, {
      method: 'GET',
      mode: 'cors'
    })
    .then(res => res.json())
    .then(res => {
      const totalSpan = document.getElementById('totalSpan');
      const total = res.balance/100;
      totalSpan.textContent = total.toLocaleString('fr', currency)

      const bankTbody = document.getElementById('bankTbody');
      while (bankTbody.firstChild) {
        bankTbody.removeChild(bankTbody.firstChild);
      }
      res.transactions.forEach(transaction => {
        const dateTd = document.createElement('td');
        const correspondantTd = document.createElement('td');
        const amountTd = document.createElement('td');

        const date = new Date(transaction.date);
        dateTd.textContent = date.toLocaleDateString('fr');

        let type;
        if(transaction.type === 'debit') {
          if(typeof(transaction.label) === 'object'){
            if(typeof(transaction.label.proof) !== 'undefined') {
              const proofA = document.createElement('a')
              proofA.href = transaction.label.proof;
              proofA.textContent = transaction.label.label;
              correspondantTd.appendChild(proofA);
            } else {
              correspondantTd.textContent = transaction.label.label;
            }
          } else {
            correspondantTd.textContent = transaction.label;
          }
          type = '-';
          amountTd.className = 'amount';
        } else {
          correspondantTd.textContent = transaction.label.substr(0, 20);
          type = '+';
          if(transaction.fees) {
            amountTd.title = transaction.fees.reduce((fees, fee) => `${fees}\n${fee.name}: ${(fee.amount/100).toLocaleString('fr', currency)}`,'');
          }
          amountTd.className = 'amount positif';
        }

        const amount = transaction.amount/100;
        amountTd.textContent = `${type} ${amount.toLocaleString('fr', currency)} `

        const bankTr = document.createElement('tr');
        bankTr.appendChild(correspondantTd)
        bankTr.appendChild(dateTd)
        bankTr.appendChild(amountTd);

        bankTbody.appendChild(bankTr);
      })
    })
  }
</script>
