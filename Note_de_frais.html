---
layout: default
---

<div class="home">
  <header class="post-header">
    <h1 class="post-title">Notes de frais</h1>
  </header>
  <ul class="pure-u-1" id="ndf">Loading...</ul>
  <fieldset style="display:none" id="ndfDetailsFieldset">
    <legend>Details</legend>
    <p id="ndfInfosP" class="pure-u-1"></p>
    <table class="pure-table pure-table-horizontal" style="width:100%; margin-bottom:2em">
      <thead>
        <tr>
          <th>Description</th>
          <th>Justificatif</th>
          <th></th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody id="ndfClaimsTbody"></tbody>
    </table>
    <p class="pure-u-2-5" style="font-style:italic;">À rembourser à <span id="ndfClaimantSpan"></span></p>
    <ul class="pure-u-7-12" style="list-style-type: none; margin-left:0px" id="ndfSignaturesUl"></ul>
  </fieldset>
</div>
<script>
  const avatars = new Avatars(Avatars.sprites.identicon);
  window.onload = () => {
    getContent('Note_de_frais')
      .then(ndf => {
        const ndfUl = document.getElementById('ndf');
        ndfUl.textContent = '';
        ndf.forEach(n => {
          if(n.name.endsWith('.json')) {
            const nLi = document.createElement('li');
            const nA = document.createElement('a');
            nA.href = `#${n.name}`;
            nA.textContent = n.name;
            nLi.appendChild(nA);
            ndfUl.appendChild(nLi);
          }
        })
        if(location.hash.substr(1) !== '') {
          return loadNdf();
        }
      })
  };

  function b64DecodeUnicode(str) {
      return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
      }).join(''))
  }

  function loadNdf() {
    const ndf = location.hash.substr(1);
    let signatures = {};
    let members;
    let noteDeFraisSha;
    let noteDeFrais = {};
    getContent(`Note_de_frais/${ndf}`)
      .then(n => {
        noteDeFraisSha = n.sha;
        noteDeFrais = JSON.parse(b64DecodeUnicode(n.content));
        const ndfDetailsFieldset = document.getElementById('ndfDetailsFieldset');
        ndfDetailsFieldset.style.display = 'block';
        const ndfInfosP = document.getElementById('ndfInfosP');
        ndfInfosP.textContent = noteDeFrais.infos

        const justificatifPromises = [];
        noteDeFrais.claims.forEach(claim => {
          const justificatifSplitted = claim.justificatif.split('/');
          const justificatifName = justificatifSplitted[justificatifSplitted.length-1];
          justificatifSplitted.pop();
          const justificatifPath = justificatifSplitted.join('/');
          justificatifPromises.push(getContent(justificatifPath));
        })
        return Promise.all(justificatifPromises);
      })
      .then(justificatifs => {
        const ndfClaimsTbody = document.getElementById('ndfClaimsTbody');
        while (ndfClaimsTbody.firstChild) {
          ndfClaimsTbody.removeChild(ndfClaimsTbody.firstChild);
        }

        let total = 0;
        noteDeFrais.claims.forEach((claim, i) => {
          const justificatifSplitted = claim.justificatif.split('/');
          const justificatifName = justificatifSplitted[justificatifSplitted.length-1];

          const descriptionTd = document.createElement('td');
          const priceTd = document.createElement('td');
          const justificatifTd = document.createElement('td');
          const shaTd = document.createElement('td');

          descriptionTd.textContent = claim.description;
          priceTd.textContent = `${(claim.price/100).toFixed(2)} €`;
          const justificatifA = document.createElement('a');
          justificatifA.textContent = justificatifName;
          justificatifA.href = claim.justificatif;
          justificatifTd.appendChild(justificatifA)
          if(justificatifs[i].find(justificatif => justificatif.name === justificatifName).sha === claim.sha){
            shaTd.textContent = '✔';
          } else {
            shaTd.textContent = '';
          }


          const claimTr = document.createElement('tr');
          claimTr.appendChild(descriptionTd)
          claimTr.appendChild(justificatifTd)
          claimTr.appendChild(shaTd);
          claimTr.appendChild(priceTd)

          ndfClaimsTbody.appendChild(claimTr);

          total += claim.price;
        })

        const claimTotalTr = document.createElement('tr');
        claimTotalTr.className = 'pure-table-odd';

        const totalTd = document.createElement('td');
        totalTd.colSpan = 3
        totalTd.textContent = 'Total'

        const totalNTd = document.createElement('td');
        totalNTd.textContent = `${(total/100).toFixed(2)} €`;

        claimTotalTr.appendChild(totalTd);
        claimTotalTr.appendChild(totalNTd);

        ndfClaimsTbody.appendChild(claimTotalTr);

        const ndfClaimantSpan = document.getElementById('ndfClaimantSpan');
        ndfClaimantSpan.textContent = noteDeFrais.claimant;

        return getContent(`Note_de_frais/${ndf}.sig`)
      })
      .then(sigFile => {
        if(typeof(sigFile.content) !== 'undefined') {
          signatures = JSON.parse(b64DecodeUnicode(sigFile.content));
        }
        return getMembers()
      })
      .then(rMembers => {
        members = rMembers;
        const keyPromises = [];
        members.forEach(member => {
          keyPromises.push(getKeys(member.login))
        })
        return Promise.all(keyPromises);
      })
      .then(keys => {
        const signaturePromises = [];
        members.forEach((member, i) => {
          if(member.login in signatures) {
            signaturePromises.push(verify(noteDeFraisSha, keys[i], signatures[member.login]));
          } else {
            signaturePromises.push(Promise.resolve(false));
          }
        })
        return Promise.all(signaturePromises);
      })
      .then(verifications => {
        const ndfSignaturesUl = document.getElementById('ndfSignaturesUl');
        ndfSignaturesUl.style['border'] = '1px solid black';
        members.forEach((member, i) => {
          const loginLi = document.createElement('li')
          loginLi.className = 'pure-u-1';
          loginLi.style['padding'] = '0.5em';
          loginLi.style['line-height'] = '60px';
          loginLi.style['font-weight'] = '600';

          if(verifications[i]) {
            const signImg = document.createElement('img');
            signImg.width = 50;

            const svg = avatars.create(signatures[member.login]);
            const svgUri = `data:image/svg+xml;base64,${btoa(svg)}`;
            signImg.src = svgUri;
            const signP = document.createElement('span');
            signP.className = 'pure-u-4-5';
            signP.textContent = `Valid signature by ${member.login}`;
            loginLi.style.color = '#77ce44';
            loginLi.appendChild(signP);
            loginLi.appendChild(signImg);
          } else {
            if(member.login in signatures) {
              loginLi.textContent = `Invalid signature by ${member.login}`;
              loginLi.style.color = '#f95e5e';
            }
            else {
              loginLi.textContent = `Not signed by ${member.login}`;
            }
          }
          ndfSignaturesUl.appendChild(loginLi);
        })

      })
  }
  window.onhashchange = loadNdf;

</script>
