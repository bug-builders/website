<html>
<head>
  <title>Verify</title>
</head>
<body>
Username : <input type="text" id="username">
<br />
Filename : <input type="text" id="filename">
<br />
Signature : <textarea id="signature"></textarea>
<button id="verify" onclick="clickVerify()">Verify</button>
<br />
<div id="status"></div>
<script>
  const repo = 'bug-builders/website';

  function importPublicKey(jwkPublicKey) {
    const format = 'jwk';
    const algorithm = {
      name: 'RSA-PSS',
      hash: { name: 'SHA-256' },
    };

    const extractable = true;
    const keyUsages = ['verify'];
    return crypto.subtle.importKey(
      format,
      jwkPublicKey,
      algorithm,
      extractable,
      keyUsages
    );
  }

  function hexStringToUint8Array(hexString) {
    if (hexString.length % 2 !== 0) {
      throw 'Invalid hexString';
    }
    const arrayBuffer = new Uint8Array(hexString.length / 2);

    for (let i = 0; i < hexString.length; i += 2) {
      const byteValue = parseInt(hexString.substr(i, 2), 16);
      if (isNaN(byteValue)) {
        throw 'Invalid hexString';
      }
      arrayBuffer[i / 2] = byteValue;
    }

    return arrayBuffer;
  }

  function asciiToUint8Array(str) {
    const chars = [];
    for (let i = 0; i < str.length; ++i) {
      chars.push(str.charCodeAt(i));
    }
    return new Uint8Array(chars);
  }

  function asciiToHexString(str) {
    return str
      .split('')
      .map(c => `0${c.charCodeAt(0).toString(16)}`.slice(-2))
      .join('');
  }

  function clickVerify(){
    const username = document.getElementById('username').value;
    const filename = document.getElementById('filename').value;
    const signature = document.getElementById('signature').value;
    verify(username, filename, signature)
      .then(isValid => {
        if(isValid){
          document.getElementById('status').innerText = 'OK';
        } else {
          document.getElementById('status').innerText = 'KO';
        }
      });
  }

  function verify(username, filename, signature) {
    let keys;
    let file;
    return fetch(`https://api.github.com/users/${username}/keys`)
      .then(response => response.json())
      .then(rKeys => {
        keys = rKeys;
        return fetch(`https://api.github.com/repos/${repo}/contents/${filename}`)
      })
      .then(response => response.json())
      .then(rFile => {
        if(rFile.sha){
          file = rFile;
        } else {
          throw rFile.message;
        }

        const pubKeyPromises = [];
        keys.forEach(key => {
          const keySpec = key.key.split(' ');
          let rawKey = atob(keySpec[1]);
          const keyParts = [];
          while(rawKey) {
            const dlen = parseInt(`0x${asciiToHexString(rawKey.substring(0, 4))}`)
            keyParts.push(rawKey.substring(4, dlen+4))
            rawKey = rawKey.substring(dlen+4)
          }
          if(keyParts[0] === 'ssh-rsa') {
            if(keyParts[2].length%8 !== 0) {
              keyParts[2] = keyParts[2].substring(1)
            }
            const n = btoa(keyParts[2]).replace(/\//g, '_').replace(/\+/g, '-').replace(/=/g, '');
            const e = btoa(keyParts[1]).replace(/\//g, '_').replace(/\+/g, '-').replace(/=/g, '');
            const jwk = {
              kty: 'RSA',
              n,
              e
            };
            pubKeyPromises.push(importPublicKey(jwk));
          }
        })
        return Promise.all(pubKeyPromises)
      })
      .then(pubKeys => {
        const signPromises = [];
        pubKeys.forEach(pubKey => {
          const signAlgorithm = {
            name: 'RSA-PSS',
            saltLength: 32, // In byte
          };
          signPromises.push(crypto.subtle.verify(
            signAlgorithm,
            pubKey,
            hexStringToUint8Array(signature),
            asciiToUint8Array(file.sha)
          ));
        })
        return Promise.all(signPromises);
      })
      .then(results => {
        let isValid = false;
        results.forEach(result => {
          if(result) {
            isValid = true;
          }
        });
        return isValid;
      })
  }
</script>
</body>
</html>
